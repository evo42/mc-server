x-mc-server-base: &mc-server-base
  env_file: .env
  image: ghcr.io/evo42/mc-server/minecraft-base
  build:
    context: ./minecraft-base
    dockerfile: Dockerfile.consolidated
  restart: unless-stopped
  networks:
    - minecraft-net
  expose:
    - "25565"

services:
  docker-proxy:
    build:
      context: ./docker-proxy
      dockerfile: Dockerfile
    container_name: mc-docker-proxy
    environment:
      - DOCKER_PROXY_TOKEN=${DOCKER_PROXY_TOKEN:-docker-proxy-secret-token}
      - ALLOWED_ORIGIN=${ADMIN_API_URL:-http://admin-api:3000}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mc-ilias:
    <<: *mc-server-base
    container_name: mc-ilias
    environment:
      MOTD: ${MC_ILIAS_NAME:-mc-Ikaria Games}
    volumes:
      - ./mc-ilias/data:/data
      - ./mc-ilias/datapacks:/data/datapacks

  mc-niilo:
    <<: *mc-server-base
    container_name: mc-niilo
    environment:
      MOTD: ${MC_NIILO_NAME:-mc-KDLK.net}
    volumes:
      - ./mc-niilo/data:/data
      - ./mc-niilo/datapacks:/data/datapacks

  mc-bgstpoelten:
    <<: *mc-server-base
    container_name: mc-bgstpoelten
    environment:
      MOTD: ${MC_BGSTPOELTEN_NAME:-mc-bgstpoelten Server}
    volumes:
      - ./landing/bgstpoelten-mc-landing/data:/data
      - ./landing/bgstpoelten-mc-landing/datapacks:/data/datapacks

  mc-htlstp:
    <<: *mc-server-base
    container_name: mc-htlstp
    environment:
      MOTD: ${MC_HTLSTP_NAME:-mc-HTL St. PÃ¶lten Server}
    volumes:
      - ./landing/htlstp-mc-landing/data:/data
      - ./landing/htlstp-mc-landing/datapacks:/data/datapacks

  mc-borgstpoelten:
    <<: *mc-server-base
    container_name: mc-borgstpoelten
    environment:
      MOTD: ${MC_BORGSTPOELTEN_NAME:-mc-borgstpoelten Server}
    volumes:
      - ./landing/borgstpoelten-mc-landing/data:/data
      - ./landing/borgstpoelten-mc-landing/datapacks:/data/datapacks

  mc-hakstpoelten:
    <<: *mc-server-base
    container_name: mc-hakstpoelten
    environment:
      MOTD: ${MC_HAKSTPOELTEN_NAME:-mc-hakstpoelten Server}
    volumes:
      - ./landing/hakstpoelten-mc-landing/data:/data
      - ./landing/hakstpoelten-mc-landing/datapacks:/data/datapacks

  mc-basop-bafep-stp:
    <<: *mc-server-base
    container_name: mc-basop-bafep-stp
    environment:
      MOTD: ${MC_BASOP_BAFEP_STP_NAME:-mc-basop-bafep-stp Server}
    volumes:
      - ./landing/basop-bafep-stp-mc-landing/data:/data
      - ./landing/basop-bafep-stp-mc-landing/datapacks:/data/datapacks

  mc-play:
    <<: *mc-server-base
    container_name: mc-play
    environment:
      MOTD: ${MC_PLAY_NAME:-mc-play Server}
    volumes:
      - ./landing/play-mc-landing/data:/data
      - ./landing/play-mc-landing/datapacks:/data/datapacks

  bungeecord:
    image: ghcr.io/evo42/mc-server/bungeecord
    build: ./bungeecord
    container_name: mc-bungeecord
    env_file:
      - .env
    environment:
      MAX_PLAYERS: ${MC_MAX_PLAYERS:-42}
      TYPE: BUNGEECORD
      SERVER_PORT: 25565
    ports:
      - "${PROXY_PORT:-25565}:25565"
    volumes:
      - ./bungeecord/config:/server
    restart: unless-stopped
    networks:
      - minecraft-net
      - proxy
    depends_on:
      - mc-ilias
      - mc-niilo

  admin-api:
    image: ghcr.io/evo42/mc-server/admin-api
    build: ./admin-api
    container_name: mc-admin-api
    env_file:
      - .env
    ports:
      - "${ADMIN_API_PORT:-3000}:3000"
    environment:
      - DOCKER_PROXY_URL=http://docker-proxy:3001
      - DOCKER_PROXY_TOKEN=${DOCKER_PROXY_TOKEN:-docker-proxy-secret-token}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
    volumes:
      - ./admin-api/admin.html:/usr/src/app/admin.html
      - ./admin-api/stats.html:/usr/src/app/stats.html
      - ./admin-api/docs.html:/usr/src/app/docs.html
      - ./admin-api/advanced-api-test.html:/usr/src/app/advanced-api-test.html
      - ./admin-api/services:/usr/src/app/services
      - ./admin-api/routes:/usr/src/app/routes
      - ./admin-api/controllers:/usr/src/app/controllers
      - ./.env:/usr/src/app/.env
      - ./landing:/usr/src/app/landing
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - docker-proxy
      - redis
    restart: unless-stopped

  admin-ui:
    image: ghcr.io/evo42/mc-server/admin-ui
    build: ./admin-ui-spa
    container_name: mc-server-admin-ui-1
    env_file:
      - .env
    ports:
      - "80"
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - admin-api

  nginx:
    build: ./nginx
    container_name: mc-nginx
    labels:
      - com.centurylinklabs.watchtower.enable=false
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./admin-ui-dist:/usr/share/nginx/html
      - ./nginx/conf.d:/etc/nginx/conf.d
      - /etc/letsencrypt:/etc/letsencrypt
      - ./landing:/var/www/landing
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - admin-api

  mcdash:
    build:
      context: ./mcdash-integration/MCDash
      dockerfile: Dockerfile
    container_name: mc-mcdash
    ports:
      - "8088:8080"
    environment:
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-admin123}
      - MINECRAFT_SERVER_DIR=/data
    volumes:
      - ./mcdash-data:/data
      - ./mc-ilias/data:/minecraft-data/mc-ilias:ro
      - ./mc-niilo/data:/minecraft-data/mc-niilo:ro
      - ./mc-bgstpoelten/data:/minecraft-data/mc-bgstpoelten:ro
      - ./mc-htlstp/data:/minecraft-data/mc-htlstp:ro
      - ./mc-borgstpoelten/data:/minecraft-data/mc-borgstpoelten:ro
      - ./mc-hakstpoelten/data:/minecraft-data/mc-hakstpoelten:ro
      - ./mc-basop-bafep-stp/data:/minecraft-data/mc-basop-bafep-stp:ro
      - ./mc-play/data:/minecraft-data/mc-play:ro
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - admin-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: mc-redis
    ports:
      - "6379:6379"
    volumes:
      - ./redis-data:/data
    networks:
      - minecraft-net
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redissecure123}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # overviewer:
  #   build:
  #     context: ./overviewer-integration
  #     dockerfile: Dockerfile
  #   container_name: mc-overviewer
  #   command: python3 -m http.server 8080 --directory /data/output
  #   ports:
  #     - "8083:8080"
  #   environment:
  #     - OVERVIEWER_DATA_DIR=/data
  #     - OVERVIEWER_OUTPUT_DIR=/data/output
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
  #   volumes:
  #     - ./mc-ilias/data:/data/worlds/mc-ilias:ro
  #     - ./mc-niilo/data:/data/worlds/mc-niilo:ro
  #     - ./landing/bgstpoelten-mc-landing/data:/data/worlds/mc-bgstpoelten:ro
  #     - ./landing/htlstp-mc-landing/data:/data/worlds/mc-htlstp:ro
  #     - ./landing/borgstpoelten-mc-landing/data:/data/worlds/mc-borgstpoelten:ro
  #     - ./landing/hakstpoelten-mc-landing/data:/data/worlds/mc-hakstpoelten:ro
  #     - ./landing/basop-bafep-stp-mc-landing/data:/data/worlds/mc-basop-bafep-stp:ro
  #     - ./landing/play-mc-landing/data:/data/worlds/mc-play:ro
  #     - ./overviewer-output:/data/output
  #     - /opt/mc-server/minecraft-assets:/minecraft-assets:ro
  #   networks:
  #     - proxy
  #     - minecraft-net
  #   depends_on:
  #     - admin-api
  #     - redis
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import overviewer_core; print('OK')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 120s

  # Overviewer Worker Containers for Multi-Container Scaling
  # overviewer-worker-1:
  #   build:
  #     context: ./overviewer-integration
  #     dockerfile: Dockerfile
  #   container_name: mc-overviewer-worker-1
  #   environment:
  #     - WORKER_ID=worker-1
  #     - WORKER_CAPACITY=2
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
  #   volumes:
  #     - ./mc-ilias/data:/data/worlds/mc-ilias:ro
  #     - ./mc-niilo/data:/data/worlds/mc-niilo:ro
  #     - ./mc-bgstpoelten/data:/data/worlds/mc-bgstpoelten:ro
  #     - ./mc-htlstp/data:/data/worlds/mc-htlstp:ro
  #     - ./mc-borgstpoelten/data:/data/worlds/mc-borgstpoelten:ro
  #     - ./mc-hakstpoelten/data:/data/worlds/mc-hakstpoelten:ro
  #     - ./mc-basop-bafep-stp/data:/data/worlds/mc-basop-bafep-stp:ro
  #     - ./mc-play/data:/data/worlds/mc-play:ro
  #     - ./overviewer-output:/data/output
  #   networks:
  #     - proxy
  #     - minecraft-net
  #   depends_on:
  #     - admin-api
  #     - redis
  #   restart: unless-stopped
  #   deploy:
  #     replicas: 1
  #     resources:
  #       limits:
  #         memory: 1G
  #         cpus: '0.5'
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import overviewer_core; print('OK')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 120s

  # overviewer-worker-2:
  #   build:
  #     context: ./overviewer-integration
  #     dockerfile: Dockerfile
  #   container_name: mc-overviewer-worker-2
  #   environment:
  #     - WORKER_ID=worker-2
  #     - WORKER_CAPACITY=2
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
  #   volumes:
  #     - ./mc-ilias/data:/data/worlds/mc-ilias:ro
  #     - ./mc-niilo/data:/data/worlds/mc-niilo:ro
  #     - ./mc-bgstpoelten/data:/data/worlds/mc-bgstpoelten:ro
  #     - ./mc-htlstp/data:/data/worlds/mc-htlstp:ro
  #     - ./mc-borgstpoelten/data:/data/worlds/mc-borgstpoelten:ro
  #     - ./mc-hakstpoelten/data:/data/worlds/mc-hakstpoelten:ro
  #     - ./mc-basop-bafep-stp/data:/data/worlds/mc-basop-bafep-stp:ro
  #     - ./mc-play/data:/data/worlds/mc-play:ro
  #     - ./overviewer-output:/data/output
  #   networks:
  #     - proxy
  #     - minecraft-net
  #   depends_on:
  #     - admin-api
  #     - redis
  #   restart: unless-stopped
  #   deploy:
  #     replicas: 1
  #     resources:
  #       limits:
  #         memory: 1G
  #         cpus: '0.5'
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import overviewer_core; print('OK')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 120s

  # overviewer-worker-3:
  #   build:
  #     context: ./overviewer-integration
  #     dockerfile: Dockerfile
  #   container_name: mc-overviewer-worker-3
  #   environment:
  #     - WORKER_ID=worker-3
  #     - WORKER_CAPACITY=2
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
  #   volumes:
  #     - ./mc-ilias/data:/data/worlds/mc-ilias:ro
  #     - ./mc-niilo/data:/data/worlds/mc-niilo:ro
  #     - ./mc-bgstpoelten/data:/data/worlds/mc-bgstpoelten:ro
  #     - ./mc-htlstp/data:/data/worlds/mc-htlstp:ro
  #     - ./mc-borgstpoelten/data:/data/worlds/mc-borgstpoelten:ro
  #     - ./mc-hakstpoelten/data:/data/worlds/mc-hakstpoelten:ro
  #     - ./mc-basop-bafep-stp/data:/data/worlds/mc-basop-bafep-stp:ro
  #     - ./mc-play/data:/data/worlds/mc-play:ro
  #     - ./overviewer-output:/data/output
  #   networks:
  #     - proxy
  #     - minecraft-net
  #   depends_on:
  #     - admin-api
  #     - redis
  #   restart: unless-stopped
  #   deploy:
  #     replicas: 1
  #     resources:
  #       limits:
  #         memory: 1G
  #         cpus: '0.5'
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import overviewer_core; print('OK')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 120s

  # Redis Cluster for High Availability
  redis-cluster:
    image: redis:7-alpine
    container_name: mc-redis-cluster
    ports:
      - "6380:6380"
    volumes:
      - ./redis-cluster-data:/data
    networks:
      - minecraft-net
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-redissecure123}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redissecure123}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # BlueMap Integration Services
  # =============================================================================

  # BlueMap API Service
  bluemap-api:
    build:
      context: ./admin-api
      dockerfile: Dockerfile
    container_name: mc-bluemap-api
    env_file:
      - .env
    ports:
      - "${BLUEMAP_API_PORT:-3001}:3001"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
      - BLUEMAP_API_URL=http://bluemap-api:3001
      - BLUEMAP_WS_URL=ws://bluemap-api:3001/ws/bluemap
    volumes:
      - ./admin-api/routes/bluemap.js:/usr/src/app/routes/bluemap.js:ro
      - ./admin-api/services/bluemapLazyService.js:/usr/src/app/services/bluemapLazyService.js:ro
      - ./admin-api/services/bluemapMetricsService.js:/usr/src/app/services/bluemapMetricsService.js:ro
      - ./bluemap-migration:/usr/src/app/bluemap-migration:ro
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/bluemap/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # BlueMap Web Interface Servers (one per Minecraft server)
  bluemap-web-mc-basop-bafep-stp:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-basop-bafep-stp
    ports:
      - "8081:8100"
    volumes:
      - ./mc-basop-bafep-stp/data:/minecraft/worlds/mc-basop-bafep-stp:ro
      - ./bluemap-migration/configs/mc-basop-bafep-stp:/webapp/conf
      - ./bluemap-data/mc-basop-bafep-stp:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  bluemap-web-mc-bgstpoelten:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-bgstpoelten
    ports:
      - "8082:8100"
    volumes:
      - ./landing/bgstpoelten-mc-landing/data:/minecraft/worlds/mc-bgstpoelten:ro
      - ./bluemap-migration/configs/mc-bgstpoelten:/webapp/conf
      - ./bluemap-data/mc-bgstpoelten:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  bluemap-web-mc-borgstpoelten:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-borgstpoelten
    ports:
      - "8083:8100"
    volumes:
      - ./landing/borgstpoelten-mc-landing/data:/minecraft/worlds/mc-borgstpoelten:ro
      - ./bluemap-migration/configs/mc-borgstpoelten:/webapp/conf
      - ./bluemap-data/mc-borgstpoelten:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  bluemap-web-mc-hakstpoelten:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-hakstpoelten
    ports:
      - "8084:8100"
    volumes:
      - ./landing/hakstpoelten-mc-landing/data:/minecraft/worlds/mc-hakstpoelten:ro
      - ./bluemap-migration/configs/mc-hakstpoelten:/webapp/conf
      - ./bluemap-data/mc-hakstpoelten:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  bluemap-web-mc-htlstp:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-htlstp
    ports:
      - "8085:8100"
    volumes:
      - ./landing/htlstp-mc-landing/data:/minecraft/worlds/mc-htlstp:ro
      - ./bluemap-migration/configs/mc-htlstp:/webapp/conf
      - ./bluemap-data/mc-htlstp:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  bluemap-web-mc-ilias:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-ilias
    ports:
      - "8086:8100"
    volumes:
      - ./mc-ilias/data:/minecraft/worlds/mc-ilias:ro
      - ./bluemap-migration/configs/mc-ilias:/webapp/conf
      - ./bluemap-data/mc-ilias:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  bluemap-web-mc-niilo:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-web-niilo
    ports:
      - "8087:8100"
    volumes:
      - ./mc-niilo/data:/minecraft/worlds/mc-niilo:ro
      - ./bluemap-migration/configs/mc-niilo:/webapp/conf
      - ./bluemap-data/mc-niilo:/webapp/data
    environment:
      - BLUEWEB_CONFIG_PATH=/webapp/conf
      - BLUEWEB_DATA_PATH=/webapp/data
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    command: ["-c", "/webapp/conf", "-w"]

  # BlueMap Render Engine (Lazy Server)
  bluemap-render-engine:
    image: ghcr.io/bluemap-minecraft/bluemap:v5.10
    container_name: mc-bluemap-render-engine
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecure123}
      - JAVA_OPTS=-Xmx2G -Xms1G
    volumes:
      - ./mc-basop-bafep-stp/data:/app/worlds/mc-basop-bafep-stp:ro
      - ./landing/bgstpoelten-mc-landing/data:/app/worlds/mc-bgstpoelten:ro
      - ./landing/borgstpoelten-mc-landing/data:/app/worlds/mc-borgstpoelten:ro
      - ./landing/hakstpoelten-mc-landing/data:/app/worlds/mc-hakstpoelten:ro
      - ./landing/htlstp-mc-landing/data:/app/worlds/mc-htlstp:ro
      - ./mc-ilias/data:/app/worlds/mc-ilias:ro
      - ./mc-niilo/data:/app/worlds/mc-niilo:ro
      - ./bluemap-render-engine/config:/app/config
      - ./bluemap-data:/app/web
      - ./bluemap-render-cache:/app/data/cache
      - ./bluemap-render-logs:/app/data/logs
    command: ["-c", "/app/config", "-r", "-u", "-w"]
    networks:
      - minecraft-net
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # Prometheus for BlueMap Metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: mc-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus-data:/prometheus:Z
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.size=10GB'
    networks:
      - proxy
      - minecraft-net
    restart: unless-stopped
    user: "root"

  # Grafana for BlueMap Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: mc-grafana
    ports:
      - "3002:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - prometheus
    restart: unless-stopped

  # BlueMap Plugin Minecraft Integration
  bluemap-plugin-dev:
    build:
      context: ./bluemap-plugin
      dockerfile: Dockerfile.dev
    container_name: mc-bluemap-plugin-dev
    environment:
      - MINECRAFT_SERVER_HOST=mc-niilo
      - MINECRAFT_SERVER_PORT=25565
      - BLUEMAP_API_URL=http://bluemap-api:3001
      - PLUGIN_DEBUG=true
    volumes:
      - ./mc-niilo/data:/data:rw
      - ./bluemap-plugin/target:/plugin/target:ro
    networks:
      - minecraft-net
    depends_on:
      - mc-niilo
      - bluemap-api
    restart: unless-stopped
    profiles:
      - development

networks:
  minecraft-net:
    driver: bridge
  proxy:
    driver: bridge
