x-mc-server-base: &mc-server-base
  env_file: .env
  image: ghcr.io/evo42/mc-server/minecraft-base
  build:
    context: ./minecraft-base
    dockerfile: Dockerfile.consolidated
  restart: unless-stopped
  networks:
    - minecraft-net
  expose:
    - "25565"

services:
  docker-proxy:
    build:
      context: ./docker-proxy
      dockerfile: Dockerfile
    container_name: mc-docker-proxy
    environment:
      - DOCKER_PROXY_TOKEN=${DOCKER_PROXY_TOKEN:-docker-proxy-secret-token}
      - ALLOWED_ORIGIN=${ADMIN_API_URL:-http://admin-api:3000}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - minecraft-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mc-ilias:
    <<: *mc-server-base
    container_name: mc-ilias
    environment:
      MOTD: ${MC_ILIAS_NAME:-mc-Ikaria Games}
    volumes:
      - ./mc-ilias/data:/data
      - ./mc-ilias/datapacks:/data/datapacks

  mc-niilo:
    <<: *mc-server-base
    container_name: mc-niilo
    environment:
      MOTD: ${MC_NIILO_NAME:-mc-KDLK.net}
    volumes:
      - ./mc-niilo/data:/data
      - ./mc-niilo/datapacks:/data/datapacks

  mc-bgstpoelten:
    <<: *mc-server-base
    container_name: mc-bgstpoelten
    environment:
      MOTD: ${MC_BGSTPOELTEN_NAME:-mc-bgstpoelten Server}
    volumes:
      - ./landing/bgstpoelten-mc-landing/data:/data
      - ./landing/bgstpoelten-mc-landing/datapacks:/data/datapacks

  mc-htlstp:
    <<: *mc-server-base
    container_name: mc-htlstp
    environment:
      MOTD: ${MC_HTLSTP_NAME:-mc-HTL St. PÃ¶lten Server}
    volumes:
      - ./landing/htlstp-mc-landing/data:/data
      - ./landing/htlstp-mc-landing/datapacks:/data/datapacks

  mc-borgstpoelten:
    <<: *mc-server-base
    container_name: mc-borgstpoelten
    environment:
      MOTD: ${MC_BORGSTPOELTEN_NAME:-mc-borgstpoelten Server}
    volumes:
      - ./landing/borgstpoelten-mc-landing/data:/data
      - ./landing/borgstpoelten-mc-landing/datapacks:/data/datapacks

  mc-hakstpoelten:
    <<: *mc-server-base
    container_name: mc-hakstpoelten
    environment:
      MOTD: ${MC_HAKSTPOELTEN_NAME:-mc-hakstpoelten Server}
    volumes:
      - ./landing/hakstpoelten-mc-landing/data:/data
      - ./landing/hakstpoelten-mc-landing/datapacks:/data/datapacks

  mc-basop-bafep-stp:
    <<: *mc-server-base
    container_name: mc-basop-bafep-stp
    environment:
      MOTD: ${MC_BASOP_BAFEP_STP_NAME:-mc-basop-bafep-stp Server}
    volumes:
      - ./landing/basop-bafep-stp-mc-landing/data:/data
      - ./landing/basop-bafep-stp-mc-landing/datapacks:/data/datapacks

  mc-play:
    <<: *mc-server-base
    container_name: mc-play
    environment:
      MOTD: ${MC_PLAY_NAME:-mc-play Server}
    volumes:
      - ./landing/play-mc-landing/data:/data
      - ./landing/play-mc-landing/datapacks:/data/datapacks

  bungeecord:
    image: ghcr.io/evo42/mc-server/bungeecord
    build: ./bungeecord
    container_name: mc-bungeecord
    env_file:
      - .env
    environment:
      MAX_PLAYERS: ${MC_MAX_PLAYERS:-42}
      TYPE: BUNGEECORD
      SERVER_PORT: 25565
    ports:
      - "${PROXY_PORT:-25565}:25565"
    volumes:
      - ./bungeecord/config:/server
    restart: unless-stopped
    networks:
      - minecraft-net
      - proxy
    depends_on:
      - mc-ilias
      - mc-niilo

  admin-api:
    image: ghcr.io/evo42/mc-server/admin-api
    build: ./admin-api
    container_name: mc-admin-api
    env_file:
      - .env
    ports:
      - "${ADMIN_API_PORT:-3000}:3000"
    environment:
      - DOCKER_PROXY_URL=http://docker-proxy:3001
      - DOCKER_PROXY_TOKEN=${DOCKER_PROXY_TOKEN:-docker-proxy-secret-token}
    volumes:
      - ./admin-api/admin.html:/usr/src/app/admin.html
      - ./admin-api/stats.html:/usr/src/app/stats.html
      - ./admin-api/docs.html:/usr/src/app/docs.html
      - ./admin-api/advanced-api-test.html:/usr/src/app/advanced-api-test.html
      - ./admin-api/services:/usr/src/app/services
      - ./admin-api/routes:/usr/src/app/routes
      - ./admin-api/controllers:/usr/src/app/controllers
      - ./.env:/usr/src/app/.env
      - ./landing:/usr/src/app/landing
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - docker-proxy
    restart: unless-stopped

  admin-ui:
    image: ghcr.io/evo42/mc-server/admin-ui
    build: ./admin-ui-spa
    container_name: mc-server-admin-ui-1
    env_file:
      - .env
    ports:
      - "80"
    networks:
      - proxy
    depends_on:
      - admin-api

  nginx:
    build: ./nginx
    container_name: mc-nginx
    labels:
      - com.centurylinklabs.watchtower.enable=false
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./admin-ui-dist:/usr/share/nginx/html
      - ./nginx/conf.d:/etc/nginx/conf.d
      - /etc/letsencrypt:/etc/letsencrypt
      - ./landing:/var/www/landing
    networks:
      - proxy
    depends_on:
      - admin-api

  mcdash:
    build:
      context: ./mcdash-integration/MCDash
      dockerfile: Dockerfile
    container_name: mc-mcdash
    ports:
      - "8082:8080"
    environment:
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-admin123}
      - MINECRAFT_SERVER_DIR=/data
    volumes:
      - ./mcdash-data:/data
      - ./mc-ilias/data:/minecraft-data/mc-ilias:ro
      - ./mc-niilo/data:/minecraft-data/mc-niilo:ro
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - admin-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  overviewer:
    build:
      context: ./overviewer-integration
      dockerfile: Dockerfile
    container_name: mc-overviewer
    ports:
      - "8081:8080"
    environment:
      - OVERVIEWER_DATA_DIR=/data
      - OVERVIEWER_OUTPUT_DIR=/data/output
    volumes:
      - ./mc-ilias/data:/data/worlds/mc-ilias:ro
      - ./mc-niilo/data:/data/worlds/mc-niilo:ro
      - ./mc-bgstpoelten/data:/data/worlds/mc-bgstpoelten:ro
      - ./mc-htlstp/data:/data/worlds/mc-htlstp:ro
      - ./mc-borgstpoelten/data:/data/worlds/mc-borgstpoelten:ro
      - ./mc-hakstpoelten/data:/data/worlds/mc-hakstpoelten:ro
      - ./mc-basop-bafep-stp/data:/data/worlds/mc-basop-bafep-stp:ro
      - ./mc-play/data:/data/worlds/mc-play:ro
      - ./overviewer-output:/data/output
    networks:
      - proxy
      - minecraft-net
    depends_on:
      - admin-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import overviewer_core; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

networks:
  minecraft-net:
    driver: bridge
  proxy:
    driver: bridge
