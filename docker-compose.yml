
version: '3.8'

x-mc-server-base: &mc-server-base
  build:
    context: ./minecraft-base
    dockerfile: Dockerfile.consolidated
  restart: unless-stopped
  networks:
    - minecraft-net
  expose:
    - "25565"
  environment:
    - EULA=${MC_EULA:-TRUE}
    - VERSION=${MC_VERSION:-1.21.1}
    - MEMORY=${MC_MEMORY:-4G}
    - MAX_MEMORY=${MC_MAX_MEMORY:-8G}
    - TYPE=PAPER
    - ONLINE_MODE=${MC_ONLINE_MODE:-false}
    - ENABLE_PROXY_CONNECTIONS=${MC_ENABLE_PROXY_CONNECTIONS:-true}
    - SERVER_DIR=/data

services:
  mc-ilias:
    <<: *mc-server-base
    container_name: mc-ilias
    environment:
      - MOTD=${MC_ILIAS_MOTD:-mc-ilias Server}
    volumes:
      - ./mc-ilias/data:/data
      - ./mc-ilias/datapacks:/data/datapacks

  mc-niilo:
    <<: *mc-server-base
    container_name: mc-niilo
    environment:
      - MOTD=${MC_NILO_MOTD:-mc-niilo Server}
    volumes:
      - ./mc-niilo/data:/data
      - ./mc-niilo/datapacks:/data/datapacks

  mc-bgstpoelten:
    <<: *mc-server-base
    container_name: mc-bgstpoelten
    environment:
      - MOTD=${MC_BGSTPOELEN_MOTD:-mc-bgstpoelten Server}
    volumes:
      - ./bgstpoelten-mc-landing/data:/data
      - ./bgstpoelten-mc-landing/datapacks:/data/datapacks

  mc-htlstp:
    <<: *mc-server-base
    container_name: mc-htlstp
    environment:
      - MOTD=${MC_HTLSTP_MOTD:-mc-htlstp Server}
    volumes:
      - ./htlstp-mc-landing/data:/data
      - ./htlstp-mc-landing/datapacks:/data/datapacks

  mc-borgstpoelten:
    <<: *mc-server-base
    container_name: mc-borgstpoelten
    environment:
      - MOTD=${MC_BORGSTPOELEN_MOTD:-mc-borgstpoelten Server}
    volumes:
      - ./borgstpoelten-mc-landing/data:/data
      - ./borgstpoelten-mc-landing/datapacks:/data/datapacks

  mc-hakstpoelten:
    <<: *mc-server-base
    container_name: mc-hakstpoelten
    environment:
      - MOTD=${MC_HAKSTPOELEN_MOTD:-mc-hakstpoelten Server}
    volumes:
      - ./hakstpoelten-mc-landing/data:/data
      - ./hakstpoelten-mc-landing/datapacks:/data/datapacks

  mc-basop-bafep-stp:
    <<: *mc-server-base
    container_name: mc-basop-bafep-stp
    environment:
      - MOTD=${MC_BASOP_BAFEP_STP_MOTD:-mc-basop-bafep-stp Server}
    volumes:
      - ./basop-bafep-stp-mc-landing/data:/data
      - ./basop-bafep-stp-mc-landing/datapacks:/data/datapacks

  mc-play:
    <<: *mc-server-base
    container_name: mc-play
    environment:
      - MOTD=${MC_PLAY_MOTD:-mc-play Server}
    volumes:
      - ./play-mc-landing/data:/data
      - ./play-mc-landing/datapacks:/data/datapacks

  bungeecord:
    build: ./bungeecord
    container_name: mc-bungeecord
    ports:
      - "${PROXY_PORT:-25565}:25565"
    volumes:
      - ./bungeecord/config:/home/bungee/server
    restart: unless-stopped
    networks:
      - minecraft-net
    depends_on:
      - mc-ilias
      - mc-niilo
      - mc-bgstpoelten
      - mc-htlstp
      - mc-borgstpoelten
      - mc-hakstpoelten
      - mc-basop-bafep-stp
      - mc-play

  admin-api:
    build: ./admin-api
    container_name: mc-admin-api
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./mc-ilias/datapacks:/app/mc-ilias/datapacks
      - ./mc-niilo/datapacks:/app/mc-niilo/datapacks
      - ./bgstpoelten-mc-landing/datapacks:/app/bgstpoelten/datapacks
      - ./htlstp-mc-landing/datapacks:/app/htlstp/datapacks
      - ./borgstpoelten-mc-landing/datapacks:/app/borgstpoelten/datapacks
      - ./hakstpoelten-mc-landing/datapacks:/app/hakstpoelten/datapacks
      - ./basop-bafep-stp-mc-landing/datapacks:/app/basop-bafep-stp/datapacks
      - ./play-mc-landing/datapacks:/app/play/datapacks
    environment:
      - NODE_ENV=production
      - ADMIN_USER=${ADMIN_USER:-admin}
      - ADMIN_PASS=${ADMIN_PASS:-admin123}
    restart: unless-stopped
    networks:
      - minecraft-net
    ports:
      - "${ADMIN_API_PORT:-3000}:3000"
    depends_on:
      - mc-ilias
      - mc-niilo
      - mc-bgstpoelten
      - mc-htlstp
      - mc-borgstpoelten
      - mc-hakstpoelten
      - mc-basop-bafep-stp
      - mc-play

  nginx:
    build: ./nginx
    container_name: mc-nginx
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./admin-ui-dist:/usr/share/nginx/html
      - ./nginx/conf.d:/etc/nginx/conf.d
    networks:
      - minecraft-net
      - proxy
    depends_on:
      - admin-api

  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 30 --cleanup
    environment:
      - DOCKER_API_VERSION=1.44
    restart: unless-stopped

networks:
  minecraft-net:
    driver: bridge
  proxy:
    driver: bridge
